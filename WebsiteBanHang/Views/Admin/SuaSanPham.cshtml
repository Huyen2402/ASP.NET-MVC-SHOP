@model WebsiteBanHang.Models.SanPham

@{
    ViewBag.Title = "SuaSanPham";
    Layout = "~/Views/Layout/AdminHomeLayout.cshtml";
    List<WebsiteBanHang.Models.KichCo> KC = ViewBag.KC as List<WebsiteBanHang.Models.KichCo>;
}



@using (Html.BeginForm("SuaSanPham", "Admin", FormMethod.Post, new { @enctype = "multipart/form-data", @id = "form-edit" }))
{


    <div class="form-horizontal">
        <h2>Sửa Sản Phẩm</h2>
        <hr />

        @Html.HiddenFor(model => model.MaSP)

        <div class="form-group">
            <label class="control-label col-md-2">Tên Sản Phẩm</label>
            <input type="hidden" name="name" id="MaSP" value="@Model.MaSP" />
            <div class="col-md-10">
                @Html.EditorFor(model => model.TenSP, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Đơn Giá</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.DonGia, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Ngày Cập Nhật</label>

            <div class="col-md-10">
                <input readonly class="form-control" id="myDate" type="text" name="NgayCapNhat" value="" />


            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Mô Tả Ngắn</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.MoTaNgan, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Mô Tả</label>

            <div class="col-md-10">
                <textarea class="form-control" name="MoTa" id="mytextarea">@ViewBag.MoTa</textarea>

            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh Hiện Tại</label>

            <div class="col-md-10">
                <img id="preview-img" style="width:150px;" src="@ViewBag.HinhAnh" alt="Alternate Text" />


            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh Mới</label>

            <div class="col-md-10">
                <input  id="hsp_tentaptin" type="file" name="HinhAnh" value="@ViewBag.HinhAnh" />


            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 1 Hiện Tại</label>

            <div class="col-md-10">
                <img id="preview-img1" style="width:150px;" src="@ViewBag.HinhAnh1" alt="Alternate Text" />


            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 1 Mới</label>

            <div class="col-md-10">


                <input id="hsp_tentaptin1" type="file" name="HinhAnh" value="@ViewBag.HinhAnh1" />


            </div>

        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 2 Hiện Tại</label>

            <div class="col-md-10">
                <img id="preview-img2" style="width:150px;" src="@ViewBag.HinhAnh2" alt="Alternate Text" />


            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 2 Mới</label>

            <div class="col-md-10">
                <input id="hsp_tentaptin2" type="file" name="HinhAnh" value="@ViewBag.HinhAnh2" />


            </div>

        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 3 Hiện Tại</label>

            <div class="col-md-10">
                <img id="preview-img3" style="width:150px;" src="@ViewBag.HinhAnh3" alt="Alternate Text" />


            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Hình Ảnh 3 Mới</label>

            <div class="col-md-10">
                <input id="hsp_tentaptin3" type="file" name="HinhAnh" value="@ViewBag.HinhAnh3" />


            </div>

        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Số Lượng Tồn</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.SoLuongTon, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>





        <div class="form-group">
            <label class="control-label col-md-2">Lượt Bình Luận</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.LuotBinhLuan, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Số Lần Mua</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.SoLanMua, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Mới</label>

            <div class="col-md-10">
                @Html.EditorFor(model => model.Moi, new { htmlAttributes = new { @class = "form-control" } })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Nhà Cung Cấp</label>

            <div class="col-md-10">

                @Html.DropDownList("MaNCC", null, htmlAttributes: new { @class = "form-control" })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Nhà Sản Xuất</label>

            <div class="col-md-10">
                @Html.DropDownList("MaNSX", null, htmlAttributes: new { @class = "form-control" })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Loại Sản Phẩm</label>

            <div class="col-md-10">
                @Html.DropDownList("MaLoaiSP", null, htmlAttributes: new { @class = "form-control" })

            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Đã Xoá</label>

            <div class="col-md-10">
                <div class="checkbox">
                    @Html.EditorFor(model => model.DaXoa)

                </div>
            </div>
        </div>


        <div class="size">
            @foreach (var i in KC)
            {
                <div class="form-group">
                    <label class="col-md-2 control-label">Kích cỡ/Màu sắc</label>
                    <div class="col-md-10">
                        <input class="form-control" type="text" name="Ten" value="@i.Ten" />

                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">Số Lượng</label>
                    <div class="col-md-10">
                        <input class="form-control" type="number" name="SL" value="@i.SL" />

                    </div>
                </div>
            }
        </div>
        <button type="button" style="float:right" id="btn-size" class="btn"><i class="fa-solid fa-plus"></i></button>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Chỉnh Sửa" class="btn btn-success" />
            </div>
        </div>
    </div>
}
<script>
    $(function () {
        $("#datepicker").datepicker();
    });
</script>


<script>
    $("#btn-size").click(function () {
        $(".size").append(' <div class= "form-group" >' +
            ' <label class="col-md-2 control-label">Kích cỡ/Màu sắc</label>' +
            '  <div class="col-md-10">' +
            '  <input class="form-control" type="text" name="Ten"  />' +

            ' </div>' +
            '  </div >' +
            ' <div class="form-group">' +
            '  <label class="col-md-2 control-label">Số Lượng</label>' +
            '   <div class="col-md-10">' +
            '  <input class="form-control" type="number" name="SL" value="0" />' +

            '  </div>' +
            ' </div>'
        )
       
    })
    tinymce.init({

        selector: '#mytextarea',

        plugins: [

            'a11ychecker', 'advlist', 'advcode', 'advtable', 'autolink', 'checklist', 'export',

            'lists', 'link', 'image', 'charmap', 'preview', 'anchor', 'searchreplace', 'visualblocks',

            'powerpaste', 'fullscreen', 'formatpainter', 'insertdatetime', 'media', 'table', 'help', 'wordcount'

        ],

        toolbar: 'undo redo | formatpainter casechange blocks | bold italic backcolor | ' +

            'alignleft aligncenter alignright alignjustify | ' +

            'bullist numlist checklist outdent indent | removeformat | a11ycheck code table help'

    });

</script>

<script>
    $(document).ready(function () {
    // Hiển thị ảnh preview (xem trước) khi người dùng chọn Ảnh

    //hình 1
    const reader = new FileReader();
    const fileInput = document.getElementById("hsp_tentaptin");
    const img = document.getElementById("preview-img");
    reader.onload = e => {
        img.src = e.target.result;
    }
    fileInput.addEventListener('change', e => {
        const f = e.target.files[0];
        reader.readAsDataURL(f);
    })


    //hình 2
    const reader1 = new FileReader();
    const fileInput1 = document.getElementById("hsp_tentaptin1");
    const img1 = document.getElementById("preview-img1");
    reader1.onload = e => {
        img1.src = e.target.result;
    }
    fileInput1.addEventListener('change', e => {
        const f1 = e.target.files[0];
        reader1.readAsDataURL(f1);
    })

    //hình 3
    const reader2 = new FileReader();
    const fileInput2 = document.getElementById("hsp_tentaptin2");
    const img2 = document.getElementById("preview-img2");
    reader2.onload = e => {
        img2.src = e.target.result;
    }
    fileInput2.addEventListener('change', e => {
        const f2 = e.target.files[0];
        reader2.readAsDataURL(f2);
    })


    //hình 4
    const reader3 = new FileReader();
    const fileInput3 = document.getElementById("hsp_tentaptin3");
    const img3 = document.getElementById("preview-img3");
    reader3.onload = e => {
        img3.src = e.target.result;
    }
    fileInput3.addEventListener('change', e => {
        const f3 = e.target.files[0];
        reader3.readAsDataURL(f3);
    })
   
   


        var a = new Array();
        $("#hsp_tentaptin").change(function () {
            a[0] = 1
            console.log(a)
        })
        a[0] = 0
        console.log(a)
        $("#hsp_tentaptin1").change(function () {
            a[1] = 2
            console.log(a)
        })
        a[1] = 0
        console.log(a)
        $("#hsp_tentaptin2").change(function () {
            a[2] = 3
            console.log(a)
        })
        a[2] = 0
        console.log(a)
        $("#hsp_tentaptin3").change(function () {
            a[3] = 4
            console.log(a)
        })
        a[3] = 0
        console.log(a)
        $('form#form-edit').submit(function (e) {
            /* const TenLoai = $("#TenLoai").val();*/

            e.preventDefault();
            //const TenSP = $("#TenSP").val();
            //const Gia = $("#Gia").val();
            //const MoTaNgan = $("#MoTaNgan").val();
            //const mytextarea = $("mytextarea").val();
            var formData = new FormData(this);
            var form = $(this);
            $.ajax({
                type: "POST",
                url: "http://localhost:62979/Admin/SuaSanPham1",
                data: form.serialize(), // serializes the form's elements.

                success: function (dataT) {
                    const MaSP = dataT.MaSP;
                    console.log(dataT) // show response from the php script.
                    if (dataT.mess == "success") {
                        //$.ajax({
                        //    type: "GET",
                        //    url: "http://localhost:62979/Admin/GetAllImg?MaSP=" + MaSP,
                           

                        //    success: function (datas) {

                        //        console.log("data", datas) // show response from the php script.
                               
                        //        /*  window.location.href = "http://localhost:62979/Admin/ContThemSP?MaSP=" + MaSP*/


                        //    }
                        //});
                        $.ajax({
                            type: "POST",
                            url: "http://localhost:3000/users/",
                            data: formData, // serializes the form's elements.
                            cache: false,
                            contentType: false,
                            processData: false,
                            success: function (data) {
                               
                                if (data.status == true) {
                                    let acc = [];
                                    if (Array.isArray(data.data.url)) {
                                        console.log("day la mang")
                                        data.data.url.forEach(i => console.log(i))
                                        for (var k = 0; k < data.data.url.length; k++) {
                                            acc.push(data.data.url[k]);
                                        }

                                        //console.log(test) // show response from the php script.
                                        $.ajax({
                                            type: "POST",
                                            url: "http://localhost:62979/Admin/EditSaveAsImg",
                                            data: { MaSP: MaSP, url: acc, a: a }, // serializes the form's elements.

                                            success: function (dataT) {

                                                console.log(dataT) // show response from the php script.
                                                if (dataT.mess == "success") {
                                                    Swal.fire({

                                                        icon: 'success',
                                                        title: 'Thành công',
                                                        text: 'Đã chỉnh sửa sản phẩm thành công',
                                                        showConfirmButton: true,

                                                    }).then((result) => {
                                                        if (result.isConfirmed) {
                                                            window.location.href = "http://localhost:62979/Admin/XemSanPham"
                                                        }
                                                    })
                                                }
                                                else {
                                                    Swal.fire({

                                                        icon: 'error',
                                                        title: 'Xảy ra lỗi',
                                                        text: 'Đã xảy ra lỗi, vui lòng thử lại sau!',
                                                        showConfirmButton: true,

                                                    })
                                                }

                                            }
                                        });

                                    }
                                    else {
                                        console.log("khong la mang")
                                        console.log(data.data.url) 
                                        let acc = [];
                                        acc.push(data.data.url)
                                        $.ajax({
                                            type: "POST",
                                            url: "http://localhost:62979/Admin/EditSaveAsImg",
                                            data: { MaSP: MaSP, url: acc, a: a }, // serializes the form's elements.

                                            success: function (dataT) {
                                                console.log(dataT) // show response from the php script.
                                                if (dataT.mess == "success") {
                                                    Swal.fire({

                                                        icon: 'success',
                                                        title: 'Thành công',
                                                        text: 'Đã chỉnh sửa sản phẩm thành công',
                                                        showConfirmButton: true,

                                                    }).then((result) => {
                                                        if (result.isConfirmed) {
                                                            window.location.href = "http://localhost:62979/Admin/XemSanPham"
                                                        }
                                                    })
                                                }
                                                else {
                                                    Swal.fire({

                                                        icon: 'error',
                                                        title: 'Xảy ra lỗi',
                                                        text: 'Đã xảy ra lỗi, vui lòng thử lại sau!',
                                                        showConfirmButton: true,

                                                    })
                                                }
                                               
                                               

                                            }
                                        });
                                    }
                                }

                            }
                        });
                    }



                }
            });

        });
    });
</script>

<script>
    const d = new Date();
    const m = new Date();
    const y = new Date();
    const hours = new Date();
    const Minutes = new Date();
    const month = m.getMonth() + 1;
    document.getElementById("myDate").value = d.getDate() + '/' + month + '/' + y.getFullYear() + ' ' + hours.getHours() + ':' + Minutes.getMinutes();
</script>



